name: üöÄ Deploy to Google Compute Engine

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to GCE VM
    runs-on: ubuntu-latest

    steps:
      # Checkout the latest code
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v3

      # Setup SSH key for connecting to GCE
      - name: üîê Setup SSH Key
        run: |
          echo "${{ secrets.GCE_SSH_PRIVATE_KEY }}" > gce-deploy-key
          chmod 600 gce-deploy-key

      # Add the GCE host to known hosts
      - name: üîÅ Add SSH Host to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.GCE_HOST }} >> ~/.ssh/known_hosts

      # Deploy the application to GCE
      - name: üöÄ Deploy via SSH to GCE
        run: |
          ssh -i gce-deploy-key ${{ secrets.GCE_USER }}@${{ secrets.GCE_HOST }} "
            set -e
            echo 'Pulling latest code from the main branch...'
            cd Parable-Mind
            git pull origin main
            echo 'Shutting down existing containers...'
            docker-compose down
            echo 'Starting new containers...'
            docker-compose up -d --build
            echo 'Deployment to GCE complete!'
          "

      - name: Success Notification
        if: success()
        uses: appleboy/discord-webhook@v1.1.0
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: GitHub Actions
          avatar: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
          message: |
            ‚úÖ **Deployment Successful**  
            **Repo:** ${{ github.repository }}  
            **Commit:** [${GITHUB_SHA:0:7}}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})  
            **Workflow:** [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Failure Notification
        if: failure()
        uses: appleboy/discord-webhook@v1.1.0
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: GitHub Actions
          avatar: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
          message: |
            ‚ùå **Deployment Failed**  
            **Repo:** ${{ github.repository }}  
            **Commit:** [${GITHUB_SHA:0:7}}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})  
            **Workflow:** [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
