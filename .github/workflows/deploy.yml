name: üöÄ Deploy to Google Compute Engine

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to GCE VM
    runs-on: ubuntu-latest

    steps:
      # Checkout the latest code
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v3

      # Setup SSH key for connecting to GCE
      - name: üîê Setup SSH Key
        run: |
          echo "${{ secrets.GCE_SSH_PRIVATE_KEY }}" > gce-deploy-key
          chmod 600 gce-deploy-key

      # Add the GCE host to known hosts
      - name: üîÅ Add SSH Host to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.GCE_HOST }} >> ~/.ssh/known_hosts

      # Deploy the application to GCE
      - name: üöÄ Deploy via SSH to GCE
        run: |
          ssh -i gce-deploy-key ${{ secrets.GCE_USER }}@${{ secrets.GCE_HOST }} "
            set -e
            echo 'Pulling latest code from the main branch...'
            cd Parable-Mind
            git pull origin main
            echo 'Shutting down existing containers...'
            docker-compose down
            echo 'Starting new containers...'
            docker-compose up -d --build
            echo 'Deployment to GCE complete!'
          "

      # Success notification
      - name: ‚úÖ Notify Success to Discord
        if: success()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: 'üöÄ Deployment to Google Compute Engine was successful!  
                 **Repository:** ${{ github.repository }}  
                 **Commit:** ${{ github.sha }}  
                 **Workflow:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'

      # Failure notification
      - name: ‚ùå Notify Failure to Discord
        if: failure()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: '‚ùå Deployment to Google Compute Engine failed!  
                 **Repository:** ${{ github.repository }}  
                 **Commit:** ${{ github.sha }}  
                 **Workflow:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
